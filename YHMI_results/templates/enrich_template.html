{% load myfilter %} {# {% include "inputGene.html" %} #}
{% load static %}




<div class="mb-0 mt-4">
  <span class="block-title"><i class="fa fa-file"></i> Results </span>
</div>

<hr class="mt-2">

<div>
  <ul class="nav nav-tabs nav-fill" id="result-tabs">
    {% for ftype in enrich_value.keys %}
    <li class="nav-item">
      {% if forloop.first %}
      <a class="nav-link active mr-2" data-toggle="tab" href="#{{ ftype }}_tab" data-graph="{{ftype}}">{{ ftype|remove_underline }}</a>
      {% else %}
      <a class="nav-link mr-2" data-toggle="tab" href="#{{ ftype }}_tab" data-graph="{{ftype}}">{{ ftype|remove_underline }}</a>
      {% endif %}
    </li>
    {% endfor %}
  </ul>

  <div class="tab-content pt-2">
    {% for ftype,data in enrich_value.items %}
      <div id="{{ftype}}_tab" class="tab-pane fade" data-graph="{{ftype}}">
        {% if ftype != 'H2A_Variant_and_H2B_Ubiquitination' %}
          {% for regionType, fdata in data.items %}
            {% if ftype != 'TF' %}
              <div class="subtitle my-2 py-2">{{regionType|remove_underline}}</div>
            {% endif %}

            <div class="card mb-3">
              <div class="card-header">
                <i class="fa fa-fw fa-bar-chart"></i> Graphic View &nbsp;&nbsp;&nbsp;&nbsp;
                <!--
                <div class="d-inline graph_radio">
                  <label class="container d-inline">Fold Enrichment
                    <input type="radio" name="graph_radio_{{ftype}}_{{regionType}}" checked data-ftype="{{ftype}}" data-graph="fold">
                    <span class="checkmark"></span>
                  </label>
                  <label class="container d-inline">P-value
                    <input type="radio" name="graph_radio_{{ftype}}_{{regionType}}" data-ftype="{{ftype}}" data-graph="pvalue">
                    <span class="checkmark"></span>
                  </label>
                </div>
                -->
              </div>
              <div class="card-body">
                <div>
                  <div id="{{ftype}}_{{regionType}}_fold_fig" class="text-center my-1 d-inline-block" style="height:450px; min-width:49%; max-width:49%;"></div>
                  <div id="{{ftype}}_{{regionType}}_pvalue_fig" class="text-center my-1 d-inline-block" style="height:450px; min-width:49%; max-width:49%;"></div>
                </div>
              </div>
            </div>
            <div class="card mb-3">
              <div class="card-header">
                <i class="fa fa-fw fa-table"></i> Table View
              </div>
              <div class="card-body">
                <table class='table p-1' id="{{ftype}}_{{regionType}}_enrich_table">
                  <thead>
                    <th class="text-left" style="width:30%;">Name</th>
                    <th class="text-left" style="width:10%;">Paper</th>
                    <th class="text-right" style="width:10%;">Fold enrichment</th>
                    <th class="text-right" style="width:15%;">Intersects /
                      <br># of input genes</th>
                    <th class="text-right" style="width:20%;">Histone Modification /
                      <br># of genes in the yeast genome</th>
                    {% if ftype == 'TF' %}
                    <th class="text-right" style="width:15%;">P-value</th>
                    {% else %}
                    <th class="text-right" style="width:9%;">P-value</th>
                    <th class="text-right" style="width:6%;">Side</th>
                    {% endif %}
                  </thead>
                  <tbody>
                    {% for value in fdata %}
                    <tr>
                      <td class="text-left">{{ value.feature }} {{ value.enrich_type|now_type}}</td>
                      <td class="text-left">{{ value.paper }}</td>
                      <td class="text-right">{{ value.fold|format_enrichment }}</td>
                      <td class="text-right">
                        <span style="display:none;">
                          {{ value.intersectOfgene.0|format_calc_percent:value.intersectOfgene.1}}
                        </span>
                        <a class="intersect"  href="#{{ value.enrichID }}_{{ value.enrich_type }}" class="intersect" data-toggle="modal" data-target="#genemodal">
                          {{ value.intersectOfgene.0 }}
                        </a>/{{ value.intersectOfgene.1 }} ({{ value.intersectOfgene.0|calc_percent:value.intersectOfgene.1}})
                      </td>
                      <td class="text-right">
                        <span style="display:none;">{{ value.intersectOfgene.2|format_calc_percent:6572}}</span>
                        {{ value.intersectOfgene.2 }}/{{ 6572 }} ({{ value.intersectOfgene.2|calc_percent:6572 }})
                      </td>
                      <td class="text-right">{{ value.pvalue.0|format_pvalue }}</td>
                      {% if ftype != 'TF' %}
                      <td class="text-right">{{ value.pvalue.1|pvalue_type }}</td>
                      {% endif %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- H2A_Variant_and_H2B_Ubiquitination -->
          {% for fftype,data in enrich_value_others.items %} 
            <div class="pt-2 mx-3" style="font-size:1.5rem;">{{fftype}}</div> <!-- Histone Modifications 種類 title-->
            <hr class="mt-1" style="border-width:5px;">

            <!-- Promoter/CDS-->
            {% for regionType, ffdata in data.items %}
              <div class="subtitle my-2 py-2">{{regionType|remove_underline}}</div>

              <!-- Graphic View -->
              <div class="card mb-3">
                <div class="card-header">
                  <i class="fa fa-fw fa-bar-chart"></i> Graphic View &nbsp;&nbsp;&nbsp;&nbsp;
                  <!--
                  <div class="d-inline graph_radio">
                    <label class="container d-inline">Fold Enrichment
                      <input type="radio" name="graph_radio_{{fftype}}" checked data-ftype="{{fftype}}" data-graph="fold">
                      <span class="checkmark"></span>
                    </label>
                    <label class="container d-inline">P-value
                      <input type="radio" name="graph_radio_{{fftype}}" data-ftype="{{fftype}}" data-graph="pvalue">
                      <span class="checkmark"></span>
                    </label>
                  </div>
                  -->
                </div>
                <div class="card-body">
                  <div class="row">
                    <div id="{{fftype}}_{{regionType}}_fold_fig" class="col-6 text-center my-1" style="height:450px; min-width:49%; max-width:49%;"></div>
                    <div id="{{fftype}}_{{regionType}}_pvalue_fig" class="col-6 text-center my-1" style="height:450px; min-width:49%; max-width:49%;"></div>
                  </div>
                </div>
              </div>
              <!-- ./ Graphic View -->

              <!-- Table View -->
              <div class="card mb-3">
                <div class="card-header"><i class="fa fa-fw fa-table"></i> Table View</div>
                <div class="card-body">
                  <table class="table p-1" id="{{fftype}}_{{regionType}}_enrich_table">
                    <thead>
                      <th class="text-left" style="width:30%;">Name</th>
                      <th class="text-left" style="width:10%;">Paper</th>
                      <th class="text-right" style="width:10%;">Fold enrichment</th>
                      <th class="text-right" style="width:20%;">Intersects /
                        <br># of input genes</th>
                      <th class="text-right" style="width:25%;">Histone Modification /
                        <br># of genes in the yeast genome</th>
                      <th class="text-right" style="width:9%;">P-value</th>
                      <th class="text-right" style="width:6%;">Side</th>
                    </thead>
                    <tbody>
                      {% for value in ffdata %}
                      <tr>
                        <td class="text-left">{{ value.feature }} {{ value.enrich_type|now_type}}</td>
                        <td class="text-left">{{ value.paper }}</td>
                        <td class="text-right">{{ value.fold|format_enrichment }}</td>
                        <td class="text-right">
                          <span style="display:none;">
                            {{ value.intersectOfgene.0|format_calc_percent:value.intersectOfgene.1}}
                          </span>
                          <a class="intersect" href="#{{ value.enrichID }}_{{ value.enrich_type }}" data-toggle="modal" data-target="#genemodal">
                            {{ value.intersectOfgene.0 }}
                          </a>/{{ value.intersectOfgene.1 }} ({{ value.intersectOfgene.0|calc_percent:value.intersectOfgene.1}})
                        </td>
                        <td class="text-right">
                          <span style="display:none;">{{ value.intersectOfgene.2|format_calc_percent:6572}}</span>
                          {{ value.intersectOfgene.2 }}/{{ 6572 }} ({{ value.intersectOfgene.2|calc_percent:6572 }})
                        </td>
                        <td class="text-right">{{ value.pvalue.0|format_pvalue }}</td>
                        <td class="text-right">{{ value.pvalue.1|pvalue_type }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- ./ Table View -->

            {% endfor %}
            <!-- ./ Promoter/CDS-->

          {% endfor %}
          <!-- ./ H2A_Variant_and_H2B_Ubiquitination -->

        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>


<!-- Modal #genemodal -->
<div class="modal fade" id="genemodal" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="modelTitleId">Intersects of  Histione Modifications</h4>&nbsp;&nbsp;
        <a id="intersect_download_a" class="btn btn-sm btn-info" href="/intersect/download?" target="_blank">
            <i class="fa fa-download" aria-hidden="true"></i> Download</a>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="min-height:694px;">
        <div class="container-fluid text-center align-middle">
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ./ Modal #genemodal -->

<style>
  .intersect_gene {width:50%!important;}
  .intersect_input, .intersect_histone {width:50%!important;}
  #genemodal table tr td {padding: 4px;}
  #genemodal table th {border-top: 4px;}
  #result .nav-tabs .nav-link:hover {
    border-color: #a5a7a9;
}
  #result .nav-tabs{border-bottom-color: #a5a7a9;}
  #result .nav-tabs .nav-link.active{
      color:#000;
      background-color: #ced4da;
      border-color: #a5a7a9 #a5a7a9 #ced4da;
  }
  #result .tab-content {
    background-color: #ced4da;
    border:1px solid #a5a7a9;
    border-top:0px;
  }
  #result .card{
    margin-right: 0.5rem;
    margin-left: 0.5rem;
  }

  .table-bordered td {border:1px solid #a5a7a9}
  #result .nav-tabs .nav-link{font-size:1.5rem;}
  #result .subtitle {
    padding: 4px 24px 0px 24px;
    margin: 0px 8px 16px 8px;
    background-color: #585858cf;
    color:white;
    font-size:1.3rem;
    border-radius: .25rem;
  }
</style>

<script>
  $(document).ready(function () {

    $("#result-tabs a").click(function () {
      var target = $(this).data('graph')
      setTimeout(function () {
        if (target == 'H2A_Variant_and_H2B_Ubiquitination') {
          // target = $("#result .tab-content div.active.show .graph_radio input[type='radio']:checked").eq(0)
          //   .data('ftype');
          // graphtype = $("#result .tab-content div.active.show .graph_radio input[type='radio']:checked").eq(
          //   0).data('graph');
          // barplot(target, graphtype);
          // target = $("#result .tab-content div.active.show .graph_radio input[type='radio']:checked").eq(1)
          //   .data('ftype');
          // graphtype = $("#result .tab-content div.active.show .graph_radio input[type='radio']:checked").eq(
          //   1).data('graph');
          barplot('H2A_Variant');
          barplot('H2BK123_Ubiquitination');
        } else {
          // var graphtype = $("#result .tab-content div.active.show .graph_radio input[type='radio']:checked")
            // .data('graph');
          barplot(target);
        }
      }, 200);
    });

    $("#result input[type='radio']").change(function () {
      var ftype = $(this).data('ftype');
      var graph = $(this).data('graph');
      barplot(ftype, graph)
    });

    // $("#intersect_download_btn").click(function(){
    //   console.log($(this).data('url'))
    //   $.ajax({
    //       url: rootURL + '/intersect/download',
    //       type: 'POST',
    //       data: {
    //         'tableID':tableID,
    //         'histone':$(this).data('url'),
    //       },
    //       success:function(res){
    //         $("#genemodal .modal-body .container-fluid").html(res);
    //         $("#intersect_datatable").DataTable({
    //           'order': [[1, "asc"], [0, 'asc']],
    //           "searching": false,
    //           "paging": false,
    //           "info": false,
    //           "lengthMenu": [[15, 25, 50, -1], [15, 25, 50, "All"]]
    //         });
    //         intersect_data[id] = res
    //       }
    //     });
    // });
  });
</script>